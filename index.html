<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>ECO-VANGUARD: THE LAST RESISTANCE | FINAL BUILD v4.0</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap');

        :root {
            --p-green: #00ff41; --p-blue: #00e5ff; --p-red: #ff3e3e; --p-yellow: #f1c40f;
            --bg-dark: #050505; --panel-bg: rgba(10, 10, 10, 0.9);
        }

        /* --- CORE CSS FRAMEWORK --- */
        * { box-sizing: border-box; cursor: crosshair; image-rendering: pixelated; }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: var(--bg-dark); color: var(--p-green);
            font-family: 'VT323', monospace; overflow: hidden;
        }

        /* Scanline & Glitch VFX */
        .crt::before {
            content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 1000; background-size: 100% 2px, 3px 100%; pointer-events: none;
        }

        /* --- LAYOUT --- */
        #game-container {
            display: grid; grid-template-columns: 280px 1fr 300px;
            grid-template-rows: 60px 1fr 180px; height: 100vh; gap: 4px;
            background: #222; border: 4px solid #444;
        }

        .panel { background: var(--bg-dark); border: 2px solid #333; position: relative; overflow: hidden; }
        header { grid-column: 1 / 4; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 2px solid var(--p-green); }

        /* --- WORLD VIEWPORT --- */
        #viewport { 
            grid-column: 2; grid-row: 2; position: relative; 
            background: #1a1a1a; transition: 1s ease;
        }

        #player {
            width: 48px; height: 48px; position: absolute;
            background: url('https://api.dicebear.com/7.x/pixel-art/svg?seed=GreenHero') no-repeat;
            transition: 0.1s linear; z-index: 100; transform: translate(-50%, -50%);
            filter: drop-shadow(0 0 10px var(--p-green));
        }

        /* --- DYNAMIC UI ELEMENTS --- */
        .bio-pot-container { text-align: center; }
        #bio-plant { font-size: 2.5rem; transition: 0.5s; display: block; }
        
        .stat-bar { width: 100%; height: 12px; background: #222; border: 1px solid #444; margin: 5px 0; }
        .stat-fill { height: 100%; width: 50%; transition: 0.5s; }

        /* --- INVENTORY & CRAFTING --- */
        .inv-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; padding: 10px; }
        .slot { 
            aspect-ratio: 1/1; background: #111; border: 2px solid #333; 
            display: flex; align-items: center; justify-content: center; font-size: 1.5rem;
        }
        .slot:hover { border-color: var(--p-blue); background: #1a1a1a; }

        /* --- DIALOGUE SYSTEM --- */
        #dialogue-area {
            grid-column: 2; grid-row: 3; background: rgba(0,0,0,0.9);
            border-top: 4px double var(--p-green); padding: 20px;
            font-size: 1.4rem; color: #fff;
        }

        /* --- ANIMATIONS --- */
        @keyframes pulse { 0% { opacity: 0.3; } 50% { opacity: 1; } 100% { opacity: 0.3; } }
        .warning { color: var(--p-red); animation: pulse 1s infinite; }
        
        /* Particle Flora */
        .leaf { position: absolute; pointer-events: none; animation: fall 3s linear forwards; }
        @keyframes fall { to { transform: translateY(400px) rotate(360deg); opacity: 0; } }

        /* Finale Overlay */
        #finale {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: #fff; display:none; z-index: 9999; flex-direction: column;
            align-items: center; justify-content: center; color: #000;
        }
    </style>
</head>
<body class="crt">

<div id="game-container">
    <header class="panel">
        <div style="font-family: 'Press Start 2P', cursive; font-size: 0.8rem;">ECO-VANGUARD OS v2100.4</div>
        <div style="display: flex; gap: 30px;">
            <div>AQI: <span id="aqi-val" class="warning">480</span></div>
            <div>CO2: <span id="co2-val">0.04%</span></div>
            <div>H√ÄNH TINH: <span id="earth-health" style="color: var(--p-blue);">S·∫ÆP CH·∫æT</span></div>
        </div>
    </header>

    <aside class="panel" style="padding: 15px;">
        <div class="bio-pot-container">
            <span id="bio-plant">ü•Ä</span>
            <div style="font-size: 0.9rem; margin-top: 10px;">BIO-METER</div>
            <div class="stat-bar"><div id="hp-bar" class="stat-fill" style="background: var(--p-red); width: 20%;"></div></div>
        </div>
        <hr border="1" style="border-color: #333; margin: 20px 0;">
        <h3 style="color: var(--p-blue);">NHI·ªÜM V·ª§</h3>
        <ul id="mission-list" style="font-size: 0.9rem; list-style: none; padding: 0;">
            <li>[!] Qu√©t r√°c t·∫°i Dustlands</li>
            <li>[ ] T√¨m chip cho E-KO</li>
            <li>[ ] ƒê√°nh b·∫°i Plastic Kraken</li>
        </ul>
    </aside>

    <main id="viewport">
        <div id="player"></div>
        <div id="entity-layer"></div> <div id="location-tag" style="position:absolute; top:20px; left:20px; background:rgba(0,0,0,0.7); padding:5px 15px; border-left:4px solid var(--p-green);">
            THE DUSTLANDS (ZONE 01)
        </div>
    </main>

    <aside class="panel">
        <h3 style="padding: 10px; margin: 0; background: #222; font-size: 1rem;">KHO ƒê·ªí T√ÅI CH·∫æ</h3>
        <div class="inv-grid" id="inventory">
            <div class="slot" title="Nh·ª±a">‚ôªÔ∏è</div><div class="slot" title="Pin">üîã</div><div class="slot"></div><div class="slot"></div>
            <div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div>
            <div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div>
            <div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div>
        </div>
        <div style="padding: 15px;">
            <h3 style="font-size: 1rem;">CH·∫æ T·∫†O (CRAFT)</h3>
            <button class="slot" style="width: 100%; height: auto; padding: 10px; font-size: 1rem; cursor: pointer;" onclick="craftItem('drone')">
                L·∫ÆP DRONE E-KO (5xüîã + 2x‚ôªÔ∏è)
            </button>
            <button class="slot" style="width: 100%; height: auto; padding: 10px; font-size: 1rem; margin-top: 10px; background: var(--p-green); color: #000;" onclick="activatePurification()">
                THANH T·∫®Y TO√ÄN V√ôNG
            </button>
        </div>
    </aside>

    <footer id="dialogue-area">
        <div id="typewriter">ƒêang kh·ªüi ƒë·ªông h·ªá th·ªëng... K·∫øt n·ªëi v·ªõi Chi·∫øn Binh Xanh...</div>
    </footer>
</div>

<div id="finale">
    <video id="webcam" autoplay style="width: 400px; height: 300px; border: 8px solid var(--p-green);"></video>
    <h1 style="font-family: 'Press Start 2P'; margin-top: 20px;">V·ªä C·ª®U TINH XU·∫§T HI·ªÜN</h1>
    <p id="finale-text" style="width: 60%; text-align: center; font-size: 1.5rem;"></p>
    <button onclick="location.reload()" style="padding: 20px; font-family: inherit; font-size: 1.2rem; cursor: pointer;">T√ÅI SINH TH·∫æ GI·ªöI L·∫¶N N·ªÆA</button>
</div>

<script>
    /* ---------------------------------------------------------
       GAME ENGINE CORE LOGIC (EXPANDED)
       --------------------------------------------------------- */
    
    const state = {
        hp: 20, aqi: 480, co2: 0.04, earth: 0,
        inventory: ['‚ôªÔ∏è', 'üîã'],
        currentZone: 'Dustlands',
        isFinale: false
    };

    const entities = [
        { name: 'R√°c Nh·ª±a', icon: 'ü•§', x: 200, y: 150, type: 'item' },
        { name: 'Pin R√≤ R·ªâ', icon: 'ü™´', x: 500, y: 300, type: 'hazard' },
        { name: 'Plastic Kraken', icon: 'üêô', x: 800, y: 200, type: 'boss' }
    ];

    // 1. Kh·ªüi t·∫°o th·ª±c th·ªÉ
    function initWorld() {
        const layer = document.getElementById('entity-layer');
        entities.forEach((en, index) => {
            const div = document.createElement('div');
            div.innerHTML = en.icon;
            div.style.position = 'absolute';
            div.style.left = en.x + 'px';
            div.style.top = en.y + 'px';
            div.style.fontSize = '2rem';
            div.style.cursor = 'pointer';
            div.id = `entity-${index}`;
            div.onclick = () => interact(index);
            layer.appendChild(div);
        });
    }

    // 2. H·ªá th·ªëng di chuy·ªÉn & V·ªát m·∫ßm xanh
    document.addEventListener('mousemove', (e) => {
        if(state.isFinale) return;
        const p = document.getElementById('player');
        const view = document.getElementById('viewport').getBoundingClientRect();
        
        let x = e.clientX - view.left;
        let y = e.clientY - view.top;

        // Gi·ªõi h·∫°n trong khung nh√¨n
        if(x > 0 && x < view.width && y > 0 && y < view.height) {
            p.style.left = x + 'px';
            p.style.top = y + 'px';
            spawnLeaf(x + view.left, y + view.top);
        }
    });

    function spawnLeaf(x, y) {
        const leaf = document.createElement('div');
        leaf.className = 'leaf';
        leaf.innerHTML = 'üåø';
        leaf.style.left = x + 'px';
        leaf.style.top = y + 'px';
        document.body.appendChild(leaf);
        setTimeout(() => leaf.remove(), 2000);
    }

    // 3. H·ªá th·ªëng t∆∞∆°ng t√°c
    function interact(id) {
        const en = entities[id];
        if(en.type === 'item') {
            log(`B·∫°n ƒë√£ nh·∫∑t ${en.name}. +5% Sinh m·ªánh.`);
            updateStats(5, -10);
            document.getElementById(`entity-${id}`).remove();
        } else if(en.type === 'boss') {
            log("C·∫¢NH B√ÅO: ƒêANG GIAO CHI·∫æN V·ªöI PLASTIC KRAKEN!");
            fightBoss();
        }
    }

    function log(msg) {
        const area = document.getElementById('typewriter');
        area.innerText = `> ${msg}`;
    }

    function updateStats(hpInc, aqiInc) {
        state.hp = Math.min(100, state.hp + hpInc);
        state.aqi = Math.max(10, state.aqi + aqiInc);
        
        document.getElementById('hp-bar').style.width = state.hp + '%';
        document.getElementById('aqi-val').innerText = state.aqi;
        
        if(state.hp > 50) {
            document.getElementById('bio-plant').innerText = 'üåø';
            document.getElementById('earth-health').innerText = 'D·∫¶N H·ªíI PH·ª§C';
        }
        if(state.hp >= 100) {
            document.getElementById('bio-plant').innerText = 'üå∏';
            document.getElementById('earth-health').innerText = 'XANH T∆Ø∆†I';
        }
    }

    // 4. H·ªá th·ªëng thanh t·∫©y & K·∫øt th√∫c s·ª≠ thi
    function activatePurification() {
        if(state.hp < 100) {
            log("NƒÉng l∆∞·ª£ng Bio-Meter ch∆∞a ƒë·ªß ƒë·ªÉ th·ª±c hi·ªán thanh t·∫©y to√†n c·∫ßu!");
            return;
        }
        
        state.isFinale = true;
        log("KH·ªûI ƒê·ªòNG C√ÅNH C·ª¨A TH·ªúI GIAN... 3... 2... 1...");
        
        setTimeout(() => {
            const fin = document.getElementById('finale');
            fin.style.display = 'flex';
            startWebcam();
            typeFinale("B·∫°n ƒë√£ th·∫Øng. Nh∆∞ng h√£y nh√¨n k·ªπ ng∆∞·ªùi trong g∆∞∆°ng. ƒê√¢y m·ªõi l√† v·ªã c·ª©u tinh th·ª±c s·ª± m√† Tr√°i ƒê·∫•t nƒÉm 2026 ƒëang c·∫ßn. H√£y b·∫Øt ƒë·∫ßu t·ª´ m·ªôt chai nh·ª±a, m·ªôt m·∫ßm c√¢y ngay h√¥m nay.");
        }, 3000);
    }

    function typeFinale(txt) {
        let i = 0;
        const target = document.getElementById('finale-text');
        const timer = setInterval(() => {
            target.innerHTML += txt[i];
            i++;
            if(i >= txt.length) clearInterval(timer);
        }, 50);
    }

    function startWebcam() {
        const video = document.getElementById('webcam');
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => video.srcObject = stream)
            .catch(() => video.style.background = "#333");
    }

    // Kh·ªüi t·∫°o game
    window.onload = () => {
        initWorld();
        log("H·ªá th·ªëng ƒë√£ s·∫µn s√†ng. Di chuy·ªÉn chu·ªôt ƒë·ªÉ kh√°m ph√°.");
    };

</script>
</body>
</html>